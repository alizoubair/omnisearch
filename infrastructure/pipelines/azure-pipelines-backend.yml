# Backend Application Deployment Pipeline
# Builds and deploys FastAPI API to Azure infrastructure

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - backend/*

pr:
  branches:
    include:
      - main
  paths:
    include:
      - backend/*

# Self-hosted agent pool (uses VMs from application tier)
# Agents are automatically installed via VM extensions
# Pool name must match the deployment group name configured in Terraform
# Default: 'backend-vms' (can be changed in terraform.tfvars)
pool:
  name: 'backend-vms'  # Self-hosted agent pool (matches backend_deployment_group_name)

variables:
  acrName: '$(ACR_NAME)'  # Set in pipeline variables
  imageName: 'omnisearch-backend'
  imageTag: '$(Build.BuildId)'

stages:
- stage: Build
  displayName: 'Build and Push Docker Image'
  jobs:
  - job: BuildAndPush
    displayName: 'Build Docker Image'
    steps:
    - task: Docker@2
      displayName: 'Login to ACR'
      inputs:
        command: login
        containerRegistry: '$(ACR_SERVICE_CONNECTION)'
    
    - task: Docker@2
      displayName: 'Build Docker Image'
      inputs:
        command: build
        repository: '$(imageName)'
        dockerfile: 'backend/Dockerfile'
        buildContext: 'backend'
        tags: |
          $(imageTag)
          latest
    
    - task: Docker@2
      displayName: 'Push to ACR'
      inputs:
        command: push
        repository: '$(imageName)'
        tags: |
          $(imageTag)
          latest
    
    - task: Docker@2
      displayName: 'Logout from ACR'
      inputs:
        command: logout
        containerRegistry: '$(ACR_SERVICE_CONNECTION)'

- stage: Deploy
  displayName: 'Deploy to VMs'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: DeployBackend
    displayName: 'Deploy to Application Tier'
    environment:
      name: 'development-backend'
      resourceType: VirtualMachine
      tags: 'api'
    strategy:
      rolling:
        maxParallel: 1
        deploy:
          steps:
          - script: |
              # Login to ACR
              echo $(ACR_PASSWORD) | docker login $(acrName).azurecr.io -u $(ACR_USERNAME) --password-stdin
              
              # Pull latest image
              docker pull $(acrName).azurecr.io/$(imageName):$(imageTag)
              
              # Stop and remove old container
              docker stop omnisearch-backend || true
              docker rm omnisearch-backend || true
              
              # Run database migrations (if needed)
              docker run --rm \
                --network host \
                -e DATABASE_URL=$(DATABASE_URL) \
                $(acrName).azurecr.io/$(imageName):$(imageTag) \
                alembic upgrade head
              
              # Run new container
              docker run -d \
                --name omnisearch-backend \
                --restart unless-stopped \
                -p 8000:8000 \
                -e DATABASE_URL=$(DATABASE_URL) \
                -e OPENAI_API_KEY=$(OPENAI_API_KEY) \
                -e AZURE_SEARCH_ENDPOINT=$(AZURE_SEARCH_ENDPOINT) \
                -e AZURE_SEARCH_KEY=$(AZURE_SEARCH_KEY) \
                -e AZURE_DOCUMENT_INTELLIGENCE_ENDPOINT=$(AZURE_DOCUMENT_INTELLIGENCE_ENDPOINT) \
                -e AZURE_DOCUMENT_INTELLIGENCE_KEY=$(AZURE_DOCUMENT_INTELLIGENCE_KEY) \
                $(acrName).azurecr.io/$(imageName):$(imageTag)
              
              # Cleanup old images
              docker image prune -f
            displayName: 'Deploy Docker Container'
          
          - script: |
              # Wait for container to be healthy
              sleep 10
              
              # Health check
              curl -f http://localhost:8000/api/health || exit 1
            displayName: 'Health Check'